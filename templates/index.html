<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Image Sorter</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <!-- Include interact.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <style>
    #left-panel {
      overflow: hidden;  /* Hide scrollbars */
      position: relative;
      /* We’ll start with “default” and switch to grab/grabbing on middle-click. */
      cursor: default;
    }
    /* Force the transform origin to top-left so the math for panning & zooming is predictable. */
    #current-image {
      transform-origin: 0 0;  /* top left */
      /* You can also do: transform-origin: top left; */
    }
  </style>
</head>
<body class="body-main">

{% if data and data['image_folder'] %}
  <div class="container" id="container">
    <div class="left-panel" id="left-panel">
      {% if data['image_list'] %}
        <div class="filename-overlay" id="filename-overlay">
          {{ file_name }}
        </div>
        <img class="current-image"
             id="current-image"
             src="{{ url_for('show_current_image') }}"
             alt="Current Image" />
      {% else %}
        <p>No images found in {{ data['image_folder'] }}</p>
      {% endif %}
    </div>
    <div class="right-panel" id="right-panel">
      <h4>Sorting image {{ data['current_index'] + 1 }} of {{ data['total_images'] }}</h4>
      <p>
        <span id="folder-display" class="folder-display">
          {{ data['image_folder'] }}
        </span>
      </p>
      {% for btn in move_buttons %}
        <div class="button-row">
          <form method="POST" action="{{ url_for('move_image') }}" class="button-form-inline">
            <input type="hidden" name="target_path" value="{{ btn['path'] }}">
            <button class="btn-move" type="submit" title="{{ btn['path'] }}">
              {{ btn['label'] }}
            </button>
          </form>
          <form method="POST" action="{{ url_for('remove_button') }}" class="button-form-inline">
            <input type="hidden" name="remove_path" value="{{ btn['path'] }}">
            <button type="submit" class="btn-remove">X</button>
          </form>
        </div>
      {% endfor %}
      <hr>
      <h5>Add New Move-to Button</h5>
      <form method="POST" action="{{ url_for('add_button') }}">
        <label>Label:</label>
        <input class="input-field" type="text" name="btn_label" required />
        <label>Destination Path:</label>
        <input class="input-field" type="text" name="btn_path" required />
        <button type="submit" class="btn-add">Add Button</button>
      </form>
    </div>
  </div>
{% else %}
  <div class="set-dir-form" id="set-dir-form">
    <h2>Select Image Directory</h2>
    <form method="POST" action="{{ url_for('set_directory') }}">
      <label for="folder">Folder Path:</label><br>
      <input class="input-field" type="text"
             id="folder"
             name="folder"
             value="{{ last_folder|default('') }}"
             placeholder="e.g. C:\images"
             required>
      <br>
      <button type="submit" class="btn-add">Load Images</button>
    </form>
  </div>
{% endif %}

{% if data and data['image_list'] %}
<script>
// ==================================================
// Global Transformation State for Pan/Zoom
// ==================================================
let currentScale = 1.0;
let translateX  = 0;
let translateY  = 0;

// References to key elements
const currentImage = document.getElementById('current-image');
const leftPanel    = document.getElementById('left-panel');

// Helper: apply the current translate/scale to the image
function updateTransform() {
  currentImage.style.transform =
    `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
}

// ==================================================
// AJAX Navigation (Next/Prev)
// ==================================================
function goNext() {
  fetch("{{ url_for('ajax_navigate', direction='next') }}")
    .then(res => res.json())
    .then(data => {
      // Reset pan/zoom on new image
      currentScale = 1.0;
      translateX = 0;
      translateY = 0;
      currentImage.style.transform = "";
      currentImage.src = data.image_url + '?_=' + new Date().getTime();

      const filenameOverlay = document.getElementById('filename-overlay');
      if (filenameOverlay) {
        filenameOverlay.textContent = data.file_name;
      }
    })
    .catch(err => {});
}

function goPrev() {
  fetch("{{ url_for('ajax_navigate', direction='prev') }}")
    .then(res => res.json())
    .then(data => {
      currentScale = 1.0;
      translateX = 0;
      translateY = 0;
      currentImage.style.transform = "";
      currentImage.src = data.image_url + '?_=' + new Date().getTime();

      const filenameOverlay = document.getElementById('filename-overlay');
      if (filenameOverlay) {
        filenameOverlay.textContent = data.file_name;
      }
    })
    .catch(err => {});
}

// ==================================================
// Keyboard Navigation for Next/Prev
// ==================================================
document.addEventListener('keydown', function(e) {
  const tag = document.activeElement.tagName.toLowerCase();
  if (tag === 'input' || tag === 'textarea') return;

  if (e.code === 'Space' || e.code === 'Enter' || e.code === 'ArrowRight') {
    e.preventDefault();
    goNext();
  }
  else if (e.code === 'ArrowLeft') {
    e.preventDefault();
    goPrev();
  }
});

// ==================================================
// Image Click => Next
// ==================================================
currentImage.addEventListener('click', function() {
  goNext();
});

// ==================================================
// Wheel Zoom (Ctrl+Wheel) in leftPanel
// ==================================================
leftPanel.addEventListener('wheel', function(e) {
  // If Ctrl is NOT held, treat the wheel as next/prev
  if (!e.ctrlKey) {
    e.preventDefault();
    if (e.deltaY < 0) {
      goPrev();
    } else {
      goNext();
    }
    return;
  }
  
  // If Ctrl is held, do zoom
  e.preventDefault();
  
  // Where in the leftPanel did the user scroll?
  const rect = leftPanel.getBoundingClientRect();
  const cursorX = e.clientX - rect.left;
  const cursorY = e.clientY - rect.top;

  // The old scale
  const oldScale = currentScale;
  // Choose a zoom factor. Adjust the "0.001" to taste.
  let newScale = currentScale * (1 - e.deltaY * 0.001);
  if (newScale < 0.1) newScale = 0.1;  // clamp minimal scale

  // The standard "keep point under cursor" approach:
  // 1) compute the image-space (local) coords of the cursor:
  const relX = (cursorX - translateX) / oldScale;
  const relY = (cursorY - translateY) / oldScale;
  // 2) update scale
  currentScale = newScale;
  // 3) solve for the new translate so that (relX, relY) remains under cursor (cursorX, cursorY)
  translateX = cursorX - relX * currentScale;
  translateY = cursorY - relY * currentScale;

  updateTransform();
});

// ==================================================
// Middle-click Panning using Plain Mouse Events
// ==================================================
let isPanning = false;
let startPanX = 0, startPanY = 0;

// When the user presses the middle mouse button on the image...
currentImage.addEventListener('mousedown', function(e) {
  if (e.button === 1) { // Middle-click
    e.preventDefault(); // Prevent default middle-click behavior (e.g. auto-scroll)
    isPanning = true;
    startPanX = e.clientX;
    startPanY = e.clientY;
    // Change the cursor on the image to a grabbing hand
    currentImage.style.cursor = 'grabbing';
  }
});

// Listen on the document so that panning continues even if the pointer leaves the image
document.addEventListener('mousemove', function(e) {
  if (!isPanning) return;
  // Calculate the mouse movement delta
  const dx = e.clientX - startPanX;
  const dy = e.clientY - startPanY;
  // Update the starting point for the next event
  startPanX = e.clientX;
  startPanY = e.clientY;
  // Update your global pan offsets and reapply the transform
  translateX += dx;
  translateY += dy;
  updateTransform();
});

// End panning when the user releases the mouse button
document.addEventListener('mouseup', function(e) {
  if (isPanning && e.button === 1) {
    isPanning = false;
    // Reset the cursor back to default
    currentImage.style.cursor = 'default';
  }
});

// ==================================================
// Rename File on Click
// ==================================================
const filenameOverlay = document.getElementById('filename-overlay');
if (filenameOverlay) {
  filenameOverlay.addEventListener('click', function() {
    const oldName = filenameOverlay.textContent.trim();
    const dotIndex = oldName.lastIndexOf('.');
    let baseName = (dotIndex > 0) ? oldName.substring(0, dotIndex) : oldName;

    const input = document.createElement('input');
    input.type = 'text';
    input.value = baseName;
    input.classList.add('rename-input');
    filenameOverlay.textContent = '';
    filenameOverlay.appendChild(input);
    input.focus();

    input.addEventListener('keydown', function(ev) {
      if (ev.key === 'Enter') {
        ev.preventDefault();
        const newBase = input.value.trim();
        if (!newBase) {
          filenameOverlay.textContent = oldName;
          return;
        }
        fetch("{{ url_for('rename_image') }}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ old_name: oldName, new_base: newBase })
        })
        .then(res => {
          if (!res.ok) {
            return res.text().then(text => { throw new Error(text); });
          }
          window.location.reload();
        })
        .catch(err => {
          alert("Rename failed: " + err.message);
          filenameOverlay.textContent = oldName;
        });
      }
    });

    input.addEventListener('blur', function() {
      filenameOverlay.textContent = oldName;
    });
  });
}

// ==================================================
// Change Folder on Click
// ==================================================
const folderDisplay = document.getElementById('folder-display');
if (folderDisplay) {
  folderDisplay.addEventListener('click', function(e) {
    if (folderDisplay.querySelector('input')) return;
    const oldFolder = folderDisplay.textContent.trim();

    const input = document.createElement('input');
    input.type = 'text';
    input.value = oldFolder;
    input.classList.add('rename-input');
    folderDisplay.textContent = '';
    folderDisplay.appendChild(input);
    input.focus();

    input.addEventListener('keydown', function(ev) {
      if (ev.key === 'Enter') {
        ev.preventDefault();
        const newFolder = input.value.trim();
        if (!newFolder) {
          folderDisplay.textContent = oldFolder;
          return;
        }
        fetch("{{ url_for('change_folder') }}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ folder: newFolder })
        })
        .then(res => {
          if (!res.ok) {
            return res.json().then(obj => { throw new Error(obj.error || res.statusText); });
          }
          return res.json();
        })
        .then(() => {
          window.location.reload();
        })
        .catch(err => {
          alert("Could not change folder: " + err.message);
          folderDisplay.textContent = oldFolder;
        });
      }
    });

    input.addEventListener('blur', function() {
      folderDisplay.textContent = oldFolder;
    });
  });
}
</script>
{% endif %}
</body>
</html>
